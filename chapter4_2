from PyQt5.QtWidgets import *
from PyQt5.QtGui import *
from PyQt5 import uic
from PyQt5.QtCore import *
import sys
import os
from openpyxl import load_workbook
import requests
import json
import xmltodict

BASE_DIR = os.path.dirname(os.path.abspath(__file__))
UI_PATH = "pharm.ui"

class MainDialog(QDialog):
    def __init__(self):
        QDialog.__init__(self, None)
        uic.loadUi(os.path.join(BASE_DIR, UI_PATH), self)
        self.setWindowFlags(Qt.WindowCloseButtonHint | Qt.WindowMaximizeButtonHint | Qt.WindowMinimizeButtonHint)
        self.word_publish.clicked.connect(self.word_publish_function)
        self.quit.clicked.connect(self.quit_function)
        
    def quit_function(self):
        sys.exit()
        
    def word_publish_function(self):
        self.status_label.setText("정보 추출중입니다.")
        excel_add = self.exceladd.text()
        country_name = self.country.text()
        category = self.category_name.text()
        titlename = self.title_name.text()
        
        info_body = ""  # 약국 정보 취합 변수
        
        if excel_add == "" or country_name == "" or category == "" or titlename == "":
            self.status_label.setText("엑셀 주소 및 입력값을 모두 입력하세요.")
            
        else:
            wb = load_workbook(excel_add + '/pharmword.xlsx')
            active_sheet = wb['입력정보']
            wordpress_id = active_sheet['B3']
            wordpress_pw = active_sheet['B4']
            service_key = active_sheet['B5']
            
            domain_name_value = active_sheet['B2']
            
            WORD_PW = wordpress_pw.value
            WORD_ID = wordpress_id.value
            SERVICE_KEY = service_key.value
            DOMAIN_NAME = domain_name_value.value
            contet = ""
            
            self.status_label.setText("본문 작성중입니다.")
            
            try:
                url = 'http://apis.data.go.kr/B552657/ErmctInsttInfoInqireService/getParmacyListInfoInqire'
                params ={'serviceKey' : SERVICE_KEY, 'Q0': country_name, 'numOfRows': 20}
                response = requests.get(url, params=params)
                content = response.content
                dict = xmltodict.parse(content)
                print(dict)
                add_lists = dict['response']['body']['items']['item']
                print(add_lists)
                for add_list in add_lists:
                    try:
                        info_body = info_body + f'''<h3 style=" font-size: 18px; border-left: #FF1493 10px solid; padding: 3px 5px 3px 5px;">{add_list['dutyName']}</h3>
                        <div><ul><li>약국 주소: {add_list['dutyAddr']}</li>
                        <li>전화번호: {str(add_list['dutyTel1'])}</li>
                        <li>진료시간: {str(add_list['dutyTime1s'])} ~ {str(add_list['dutyTime1c'])}</li>
                        <li>비고: {str(add_list['dutyEtc'])}</li>
                        </ul></div>'''
                        
                    except:
                        info_body = info_body + f'''<h3 style=" font-size: 18px; border-left: #FF1493 10px solid; padding: 3px 5px 3px 5px;">{add_list['dutyName']}</h3>
                            <div style="font-size: 18px;"><ul><li>약국 주소: {add_list['dutyAddr']}</li>
                            <li>전화번호: {str(add_list['dutyTel1'])}</li>
                            <li>진료시간: {str(add_list['dutyTime1s'])} ~ {str(add_list['dutyTime1c'])}</li>
                            </ul></div>'''
                            
            except:
                self.status_label.setText("약국(공공)정보를 불러올 수 없습니다. 공공 API 정상 접속여부 확인하세요.")
                    
            else:
                contet = f'''<h2 style="font-size: 22px; border-bottom: #FF1493 2px solid; margin: 5px 0px; padding: 3px 5px 3px 5px;">{country_name} 약국 20곳</h2><br></br>{info_body}<br></br>'''
                    
                try:
                    document = f'''<!DOCTYPE html><html><head></head><body>{contet}<br></br></body></html>'''
                                    
                    payload = {"status": "publish","slug": country_name,"title": titlename,"content": document,"categories" : [int(category)],}        
                                     
                    requests.post((DOMAIN_NAME + "/wp-json/wp/v2/posts"),
                        data=json.dumps(payload),headers={'Content-type': "application/json"},auth=(WORD_ID, WORD_PW))
                    
                    self.status_label.setText("포스팅 작성 완료입니다.")
                        
                except:
                    self.status_label.setText("워드프레스 접속오류입니다. ID/PW 혹은 XMLRPC 조건 확인하세요.")
                    
QApplication.setStyle("fusion")
app = QApplication(sys.argv)
main_dialog = MainDialog()
main_dialog.show()

sys.exit(app.exec_())
